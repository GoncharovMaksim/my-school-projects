# Логика уведомлений

## Обзор

Система уведомлений отправляет push-уведомления пользователям, которые не выполнили ежедневные задания по математике и английскому языку.

## Критерии для математики

### Основные критерии

Пользователь считается выполнившим задания по математике, если он:

- Выполнил **ВСЕ 4 оператора** (+, -, \*, /) с требуемым количеством записей
- Каждый оператор может быть выполнен на любом уровне сложности

### Требования по уровням сложности

- **Уровень 1**: 3 записи на оператор
- **Уровень 2**: 2 записи на оператор
- **Уровень 3**: 1 запись на оператор

### Примеры выполнения

**Пример 1 - Комбинирование уровней:**

```
Сложение: 3 записи уровня 1 (3/3) ✅
Вычитание: 2 записи уровня 2 (2/2) ✅
Умножение: 1 запись уровня 3 (1/1) ✅
Деление: 3 записи уровня 1 (3/3) ✅
→ Уведомление НЕ отправляется
```

**Пример 2 - Все на одном уровне:**

```
Сложение: 3 записи уровня 1 (3/3) ✅
Вычитание: 3 записи уровня 1 (3/3) ✅
Умножение: 3 записи уровня 1 (3/3) ✅
Деление: 3 записи уровня 1 (3/3) ✅
→ Уведомление НЕ отправляется
```

**Пример 3 - Не выполнено:**

```
Сложение: 3 записи уровня 1 (3/3) ✅
Вычитание: 2 записи уровня 2 (2/2) ✅
Умножение: 1 запись уровня 3 (1/1) ✅
Деление: 2 записи уровня 1 (2/3) ❌
→ Уведомление отправляется
```

## Критерии для английского языка

Пользователь считается выполнившим задания по английскому языку, если:

- Выполнил хотя бы 1 задание с любой оценкой (>= 1)

## Endpoints

### Устаревший endpoint (комбинированный)

- `GET /api/cron` - запускает проверку для обоих предметов

### Новые endpoints (рекомендуемые)

- `GET /api/cron/math` - проверка только математики
- `GET /api/cron/english` - проверка только английского языка

## Логирование

Система ведет подробные логи для отладки:

- Детали найденных записей за день
- Группировка статистики по пользователям
- Анализ выполнения критериев для каждого пользователя
- Решение о отправке уведомлений

## Примеры логов

```
[INFO] Found records for today with grade >= 4: 16
[DEBUG] Today stats details: [...]
[DEBUG] Grouped user stats: [...]
[DEBUG] Analyzing user 674d794887f5dd6b175f1086: {...}
[DEBUG] User 674d794887f5dd6b175f1086 completion status: {...}
[DEBUG] User 674d794887f5dd6b175f1086 meets criteria - added to sufficient stats
[INFO] Found users with sufficient stats: [...]
[INFO] Users to notify: [...]
```

## Настройка

Критерии можно настроить в файле `configs/notificationCriteria.ts`:

```typescript
export const NOTIFICATION_CRITERIA = {
  math: {
    minGrade: 4,
    difficultyLevels: {
      1: { requiredRecords: 3, operators: ['+', '-', '*', '/'] },
      2: { requiredRecords: 2, operators: ['+', '-', '*', '/'] },
      3: { requiredRecords: 1, operators: ['+', '-', '*', '/'] },
    },
  },
  english: {
    minGrade: 1,
    minRecords: 1,
  },
};
```
