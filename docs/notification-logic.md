# Логика системы уведомлений

## Обзор

Система уведомлений автоматически отправляет напоминания пользователям, которые не выполнили минимальные требования по обучению за день.

## Критерии для математики

### Условия исключения уведомлений:

Пользователь НЕ получит уведомление, если выполнит хотя бы один из следующих уровней сложности:

#### Уровень 1 (Легкий):

- **3 записи** для каждого оператора (+, -, \*, /)
- Все записи должны иметь оценку **4 или 5**
- **Итого:** минимум 12 записей

#### Уровень 2 (Средний):

- **2 записи** для каждого оператора (+, -, \*, /)
- Все записи должны иметь оценку **4 или 5**
- **Итого:** минимум 8 записей

#### Уровень 3 (Сложный):

- **1 запись** для каждого оператора (+, -, \*, /)
- Все записи должны иметь оценку **4 или 5**
- **Итого:** минимум 4 записи

### Примеры выполнения:

**Пример 1 - Уровень 1:**

```
Пользователь выполнил:
- Сложение (уровень 1): 3 записи с оценкой 4-5
- Вычитание (уровень 1): 3 записи с оценкой 4-5
- Умножение (уровень 1): 3 записи с оценкой 4-5
- Деление (уровень 1): 3 записи с оценкой 4-5
→ Уведомление НЕ отправляется
```

**Пример 2 - Уровень 2:**

```
Пользователь выполнил:
- Сложение (уровень 2): 2 записи с оценкой 4-5
- Вычитание (уровень 2): 2 записи с оценкой 4-5
- Умножение (уровень 2): 2 записи с оценкой 4-5
- Деление (уровень 2): 2 записи с оценкой 4-5
→ Уведомление НЕ отправляется
```

**Пример 3 - Недостаточно:**

```
Пользователь выполнил:
- Сложение (уровень 1): 3 записи с оценкой 4-5
- Вычитание (уровень 1): 2 записи с оценкой 4-5 (недостаточно)
- Умножение (уровень 1): 0 записей
- Деление (уровень 1): 0 записей
→ Уведомление отправляется
```

## Критерии для английского языка

### Условия исключения уведомлений:

Пользователь НЕ получит уведомление, если выполнит ВСЕ следующие условия:

1. **Минимум 5 записей** за день
2. **Все записи** должны иметь оценку **4 или 5**
3. **Средний процент правильных ответов** >= 70%
4. **Среднее время на задание** >= 2 минуты (120 секунд)

### Примеры выполнения:

**Пример 1 - Выполнено:**

```
Пользователь выполнил:
- 6 записей с оценкой 4-5
- Средний процент правильных: 75%
- Среднее время: 3 минуты
→ Уведомление НЕ отправляется
```

**Пример 2 - Не выполнено (мало записей):**

```
Пользователь выполнил:
- 3 записи с оценкой 4-5 (недостаточно)
- Средний процент правильных: 80%
- Среднее время: 2.5 минуты
→ Уведомление отправляется
```

**Пример 3 - Не выполнено (низкий процент):**

```
Пользователь выполнил:
- 7 записей с оценкой 4-5
- Средний процент правильных: 60% (недостаточно)
- Среднее время: 3 минуты
→ Уведомление отправляется
```

## Конфигурация

Критерии настраиваются в файле `configs/notificationCriteria.ts`:

```typescript
export const NOTIFICATION_CRITERIA = {
  math: {
    minGrade: 4,
    difficultyLevels: {
      1: { requiredRecords: 3, operators: ['+', '-', '*', '/'] },
      2: { requiredRecords: 2, operators: ['+', '-', '*', '/'] },
      3: { requiredRecords: 1, operators: ['+', '-', '*', '/'] },
    },
  },
  english: {
    minGrade: 4,
    minRecords: 5,
    minPercentCorrect: 70,
    minTimeSpent: 120,
  },
};
```

## Логирование

Система ведет подробные логи для отладки:

```
[INFO] Filter date set to: 2024-01-15T00:00:00.000Z
[INFO] Found subscriptions: ['user1', 'user2', 'user3']
[INFO] Found records for today with grade >= 4: 25
[INFO] Found users with sufficient stats: [
  {
    userId: 'user1',
    totalRecords: 12,
    level1Complete: true,
    level2Complete: false,
    level3Complete: false,
    byDifficulty: { ... }
  }
]
[INFO] Users to notify: ['user2', 'user3']
[INFO] Sending notification to userId: user2
[INFO] Notification successfully sent to userId: user2
```

## Файлы системы

- `configs/notificationCriteria.ts` - Конфигурация критериев
- `app/pushNotification/filterCronPushNotificationMath.ts` - Логика для математики
- `app/pushNotification/filterCronPushNotificationEnglish.ts` - Логика для английского
- `app/pushNotification/actions.ts` - Функции отправки уведомлений
